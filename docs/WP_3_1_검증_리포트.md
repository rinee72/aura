# WP-3.1: 질문 큐레이션 대시보드 검증 리포트

## 📋 개요

**Work Package**: WP-3.1: 질문 큐레이션 대시보드  
**검증 일자**: 2024년  
**검증자**: AI Assistant  
**상태**: ✅ 완료

## 🎯 목적

셀럽이 좋아요 기반으로 정제된 Top 질문을 확인할 수 있는 대시보드를 구현하여, 수백 개의 질문 중에서 가장 인기 있는 질문만 선별하여 확인할 수 있도록 하여 피로도를 크게 감소시키는 것이 목적입니다.

## ✅ 완료 조건 검증

### 1. 셀럽이 좋아요 Top 10 질문을 확인할 수 있음

**검증 결과**: ✅ **통과**

**구현 내용**:
- `QuestionCurationService.getTopQuestions()` 메서드가 `limit` 파라미터를 받아 Top N 질문을 조회합니다.
- 기본값은 10개이며, 필요에 따라 조정 가능합니다.
- 좋아요 수(`like_count`) 기준으로 내림차순 정렬됩니다.
- 동일한 좋아요 수일 경우 최신순(`created_at DESC`)으로 정렬됩니다.

**코드 위치**:
```12:113:aura_app/lib/features/celebrity/services/question_curation_service.dart
class QuestionCurationService {
  /// Top 질문 조회 (좋아요순)
  /// 
  /// [limit]: 조회할 질문 수 (기본값: 10)
  /// [dateFilter]: 날짜 필터 ('today', 'week', 'month', 'all', 기본값: 'all')
  /// [statusFilter]: 상태 필터 ('all', 'pending', 'answered', 기본값: 'all')
  /// 
  /// Returns: 큐레이션된 질문 목록 (작성자 정보 포함)
  /// Throws: 질문 조회 실패 시, 권한 없음 시
  static Future<List<CuratedQuestionModel>> getTopQuestions({
    int limit = 10,
    String dateFilter = 'all',
    String statusFilter = 'all',
  }) async {
    // ... 구현 내용 ...
  }
}
```

### 2. 날짜별 필터링이 정상 작동함

**검증 결과**: ✅ **통과**

**구현 내용**:
- 날짜 필터 옵션: 'today', 'week', 'month', 'all'
- `QuestionCurationDashboardScreen`에서 FilterChip UI로 날짜 필터를 선택할 수 있습니다.
- 필터 변경 시 자동으로 질문 목록이 새로고침됩니다.

**코드 위치**:
```60:74:aura_app/lib/features/celebrity/services/question_curation_service.dart
      switch (dateFilter) {
        case 'today':
          startDate = DateTime(now.year, now.month, now.day);
          break;
        case 'week':
          startDate = now.subtract(Duration(days: 7));
          break;
        case 'month':
          startDate = DateTime(now.year, now.month, 1);
          break;
        case 'all':
        default:
          startDate = null;
          break;
      }
```

```165:212:aura_app/lib/features/celebrity/screens/question_curation_dashboard_screen.dart
                    // 날짜 필터 탭
                    Text(
                      '날짜',
                      style: AppTypography.caption.copyWith(
                        color: AppColors.textSecondary,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    const SizedBox(height: AppSpacing.sm),
                    Row(
                      children: [
                        _buildFilterChip(
                          label: '전체',
                          value: 'all',
                          selected: _dateFilter == 'all',
                          onSelected: (selected) {
                            if (selected) _onDateFilterChanged('all');
                          },
                        ),
                        const SizedBox(width: AppSpacing.xs),
                        _buildFilterChip(
                          label: '오늘',
                          value: 'today',
                          selected: _dateFilter == 'today',
                          onSelected: (selected) {
                            if (selected) _onDateFilterChanged('today');
                          },
                        ),
                        const SizedBox(width: AppSpacing.xs),
                        _buildFilterChip(
                          label: '이번 주',
                          value: 'week',
                          selected: _dateFilter == 'week',
                          onSelected: (selected) {
                            if (selected) _onDateFilterChanged('week');
                          },
                        ),
                        const SizedBox(width: AppSpacing.xs),
                        _buildFilterChip(
                          label: '이번 달',
                          value: 'month',
                          selected: _dateFilter == 'month',
                          onSelected: (selected) {
                            if (selected) _onDateFilterChanged('month');
                          },
                        ),
                      ],
                    ),
```

### 3. 미답변/답변완료 상태별 필터링이 작동함

**검증 결과**: ✅ **통과**

**구현 내용**:
- 상태 필터 옵션: 'all', 'pending', 'answered'
- `QuestionCurationDashboardScreen`에서 FilterChip UI로 상태 필터를 선택할 수 있습니다.
- 필터 변경 시 자동으로 질문 목록이 새로고침됩니다.
- `getUnansweredQuestions()` 및 `getAnsweredQuestions()` 헬퍼 메서드도 제공됩니다.

**코드 위치**:
```87:90:aura_app/lib/features/celebrity/services/question_curation_service.dart
      // 상태 필터 적용
      if (statusFilter != 'all') {
        query = query.eq('status', statusFilter);
      }
```

```215:253:aura_app/lib/features/celebrity/screens/question_curation_dashboard_screen.dart
                    // 상태 필터 탭
                    Text(
                      '상태',
                      style: AppTypography.caption.copyWith(
                        color: AppColors.textSecondary,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    const SizedBox(height: AppSpacing.sm),
                    Row(
                      children: [
                        _buildFilterChip(
                          label: '전체',
                          value: 'all',
                          selected: _statusFilter == 'all',
                          onSelected: (selected) {
                            if (selected) _onStatusFilterChanged('all');
                          },
                        ),
                        const SizedBox(width: AppSpacing.xs),
                        _buildFilterChip(
                          label: '답변대기',
                          value: 'pending',
                          selected: _statusFilter == 'pending',
                          onSelected: (selected) {
                            if (selected) _onStatusFilterChanged('pending');
                          },
                        ),
                        const SizedBox(width: AppSpacing.xs),
                        _buildFilterChip(
                          label: '답변완료',
                          value: 'answered',
                          selected: _statusFilter == 'answered',
                          onSelected: (selected) {
                            if (selected) _onStatusFilterChanged('answered');
                          },
                        ),
                      ],
                    ),
```

### 4. 질문 선택 시 답변 작성 화면으로 이동 가능

**검증 결과**: ✅ **통과**

**구현 내용**:
- `CuratedQuestionCard` 위젯에서 질문 카드를 탭하면 답변 작성 화면으로 이동합니다.
- 라우트: `/celebrity/questions/:questionId/answer`
- WP-3.2에서 답변 작성 화면이 구현될 예정이며, 현재는 플레이스홀더 화면이 표시됩니다.

**코드 위치**:
```126:130:aura_app/lib/features/celebrity/screens/question_curation_dashboard_screen.dart
  /// 질문 선택 처리 (답변 작성 화면으로 이동)
  void _onQuestionTap(CuratedQuestionModel curatedQuestion) {
    // WP-3.2에서 구현될 답변 작성 화면으로 이동
    context.push('/celebrity/questions/${curatedQuestion.id}/answer');
  }
```

```330:333:aura_app/lib/features/celebrity/screens/question_curation_dashboard_screen.dart
                    return CuratedQuestionCard(
                      curatedQuestion: curatedQuestion,
                      onTap: () => _onQuestionTap(curatedQuestion),
                    );
```

### 5. 매니저가 숨긴 질문은 표시되지 않음

**검증 결과**: ✅ **통과**

**구현 내용**:
- `is_hidden = false` 조건이 쿼리에 적용되어 있습니다.
- RLS 정책에서도 셀럽은 숨김되지 않은 질문만 조회할 수 있도록 설정되어 있습니다.

**코드 위치**:
```76:80:aura_app/lib/features/celebrity/services/question_curation_service.dart
      // 기본 쿼리: 숨겨지지 않은 질문만
      dynamic query = client
          .from('questions')
          .select()
          .eq('is_hidden', false); // 매니저가 숨긴 질문 제외
```

**RLS 정책 확인**:
```344:354:aura_app/supabase/migrations/001_initial_schema.sql
-- 셀럽: 숨김되지 않은 질문 조회만 가능
DROP POLICY IF EXISTS "Celebrities can view non-hidden questions" ON public.questions;
CREATE POLICY "Celebrities can view non-hidden questions"
    ON public.questions FOR SELECT
    USING (
        is_hidden = false AND
        EXISTS (
            SELECT 1 FROM public.users u
            WHERE u.id = auth.uid() AND u.role = 'celebrity'
        )
    );
```

### 6. 좋아요 수가 실시간으로 반영됨 (Realtime 구독, 선택)

**검증 결과**: ⚠️ **선택 사항 - 미구현**

**현재 상태**:
- 좋아요 수는 데이터베이스에서 조회 시점의 값을 표시합니다.
- 실시간 구독 기능은 아직 구현되지 않았습니다.

**권장 사항**:
- 필요 시 Supabase Realtime을 사용하여 `questions` 테이블의 `like_count` 변경을 구독할 수 있습니다.
- 현재는 새로고침 버튼을 통해 최신 좋아요 수를 확인할 수 있습니다.

## 🔒 권한 검증

### 클라이언트 사이드 권한 검증

**검증 결과**: ✅ **통과**

**구현 내용**:
- `QuestionCurationService.getTopQuestions()`에서 셀럽 권한을 검증합니다.
- `QuestionCurationDashboardScreen`에서도 권한을 검증하고, 권한이 없으면 에러 메시지를 표시합니다.
- `CelebrityDashboardScreen`의 `_QuestionCurationSection`에서도 셀럽이 아닌 경우 섹션을 숨깁니다.

**코드 위치**:
```29:54:aura_app/lib/features/celebrity/services/question_curation_service.dart
      final client = SupabaseConfig.client;
      final currentUser = client.auth.currentUser;

      // 권한 검증: 셀럽만 질문 큐레이션 조회 가능
      if (currentUser == null) {
        throw Exception('로그인이 필요합니다.');
      }

      // 현재 사용자 정보 조회
      final userResponse = await client
          .from('users')
          .select()
          .eq('id', currentUser.id)
          .maybeSingle();

      if (userResponse == null) {
        throw Exception('사용자 정보를 찾을 수 없습니다.');
      }

      final user = UserModel.fromJson(userResponse);

      // 셀럽 권한 검증 (클라이언트 사이드)
      try {
        PermissionChecker.requireRole(user, PermissionChecker.roleCelebrity);
      } catch (e) {
        throw Exception('질문 큐레이션은 셀럽만 사용할 수 있습니다.');
      }
```

```51:74:aura_app/lib/features/celebrity/screens/question_curation_dashboard_screen.dart
      // 권한 검증 (클라이언트 사이드)
      final authProvider = Provider.of<AuthProvider>(context, listen: false);
      final user = authProvider.currentUser;
      
      try {
        PermissionChecker.requireRole(user, PermissionChecker.roleCelebrity);
      } on PermissionException catch (e) {
        if (mounted) {
          PermissionErrorHandler.handleError(context, e);
          setState(() {
            _errorMessage = '질문 큐레이션은 셀럽만 사용할 수 있습니다.';
            _isLoading = false;
          });
        }
        return;
      } catch (e) {
        if (mounted) {
          setState(() {
            _errorMessage = '권한 확인 중 오류가 발생했습니다: $e';
            _isLoading = false;
          });
        }
        return;
      }
```

### 서버 사이드 권한 검증 (RLS)

**검증 결과**: ✅ **통과**

**구현 내용**:
- Supabase RLS 정책에 의해 셀럽은 숨김되지 않은 질문만 조회할 수 있습니다.
- RLS 정책은 데이터베이스 레벨에서 강제되므로 클라이언트 사이드 우회가 불가능합니다.

## 📦 구현된 컴포넌트

### 1. 질문 큐레이션 서비스

**파일**: `aura_app/lib/features/celebrity/services/question_curation_service.dart`

**주요 메서드**:
- `getTopQuestions()`: 좋아요순 Top N 질문 조회
- `getUnansweredQuestions()`: 미답변 질문만 조회
- `getAnsweredQuestions()`: 답변완료 질문만 조회
- `getQuestionsByDateRange()`: 날짜 범위별 질문 조회

### 2. 질문 큐레이션 모델

**파일**: `aura_app/lib/features/celebrity/models/curated_question_model.dart`

**특징**:
- `QuestionModel`과 작성자 정보(`UserModel`)를 포함합니다.
- 편의 getter 메서드를 제공합니다 (`id`, `content`, `likeCount`, `status`, `isAnswered` 등).

### 3. 질문 큐레이션 대시보드 화면

**파일**: `aura_app/lib/features/celebrity/screens/question_curation_dashboard_screen.dart`

**기능**:
- Top 질문 리스트 표시
- 날짜별 필터 (오늘, 이번 주, 이번 달, 전체)
- 상태별 필터 (전체, 답변대기, 답변완료)
- 새로고침 버튼
- 로딩 인디케이터
- 에러 메시지 표시

### 4. 질문 카드 위젯

**파일**: `aura_app/lib/features/celebrity/widgets/curated_question_card.dart`

**표시 정보**:
- 질문 내용
- 좋아요 수
- 작성 시간
- 답변 상태 배지 (미답변/답변완료)
- 작성자 정보

### 5. 셀럽 대시보드 통합

**파일**: `aura_app/lib/features/celebrity/screens/celebrity_dashboard_screen.dart`

**기능**:
- 질문 큐레이션 섹션 미리보기 (최대 3개)
- "전체 보기" 버튼으로 전체 대시보드로 이동

### 6. 라우팅

**파일**: `aura_app/lib/core/router/app_router.dart`

**라우트**:
- `/celebrity/questions/curation`: 질문 큐레이션 대시보드
- `/celebrity/questions/:questionId/answer`: 답변 작성 화면 (플레이스홀더)

## 🐛 발견된 문제 및 해결

### 문제 1: 권한 검증 누락

**문제**: 초기 구현에서 클라이언트 사이드 권한 검증이 없었습니다.

**해결**: 
- `QuestionCurationService.getTopQuestions()`에 셀럽 권한 검증 추가
- `QuestionCurationDashboardScreen`에 권한 검증 및 에러 처리 추가
- `CelebrityDashboardScreen`의 `_QuestionCurationSection`에 권한 검증 추가

### 문제 2: 에러 처리 개선

**문제**: 초기 구현에서 에러 메시지가 사용자에게 명확하게 전달되지 않았습니다.

**해결**:
- 권한 오류, 네트워크 오류 등에 대한 구체적인 에러 메시지 추가
- `PermissionErrorHandler`를 사용하여 권한 오류 처리

## 📝 테스트 권장 사항

### 수동 테스트 시나리오

1. **셀럽 계정으로 로그인**
   - 셀럽 대시보드에서 질문 큐레이션 섹션 확인
   - "전체 보기" 버튼 클릭하여 전체 대시보드 확인

2. **날짜 필터 테스트**
   - "오늘" 필터 선택 → 오늘 작성된 질문만 표시되는지 확인
   - "이번 주" 필터 선택 → 이번 주 작성된 질문만 표시되는지 확인
   - "이번 달" 필터 선택 → 이번 달 작성된 질문만 표시되는지 확인
   - "전체" 필터 선택 → 모든 질문 표시되는지 확인

3. **상태 필터 테스트**
   - "답변대기" 필터 선택 → 미답변 질문만 표시되는지 확인
   - "답변완료" 필터 선택 → 답변완료 질문만 표시되는지 확인
   - "전체" 필터 선택 → 모든 상태의 질문 표시되는지 확인

4. **질문 선택 테스트**
   - 질문 카드 탭 → 답변 작성 화면으로 이동하는지 확인

5. **권한 테스트**
   - 팬 계정으로 로그인 → 질문 큐레이션 대시보드 접근 시도 → 권한 오류 메시지 표시되는지 확인
   - 매니저 계정으로 로그인 → 질문 큐레이션 대시보드 접근 시도 → 권한 오류 메시지 표시되는지 확인

6. **숨김 질문 테스트**
   - 매니저가 질문을 숨김 처리
   - 셀럽 계정으로 로그인 → 숨김 처리된 질문이 표시되지 않는지 확인

## ✅ 최종 검증 결과

| 완료 조건 | 상태 | 비고 |
|---------|------|------|
| 셀럽이 좋아요 Top 10 질문을 확인할 수 있음 | ✅ 통과 | 기본값 10개, 조정 가능 |
| 날짜별 필터링이 정상 작동함 | ✅ 통과 | 오늘, 이번 주, 이번 달, 전체 |
| 미답변/답변완료 상태별 필터링이 작동함 | ✅ 통과 | 전체, 답변대기, 답변완료 |
| 질문 선택 시 답변 작성 화면으로 이동 가능 | ✅ 통과 | WP-3.2에서 구현 예정 |
| 매니저가 숨긴 질문은 표시되지 않음 | ✅ 통과 | RLS 정책 및 쿼리 조건 적용 |
| 좋아요 수가 실시간으로 반영됨 | ⚠️ 선택 사항 | 새로고침으로 최신화 가능 |

## 🎉 결론

WP-3.1: 질문 큐레이션 대시보드의 모든 필수 요구사항이 성공적으로 구현되었습니다. 셀럽이 좋아요 기반으로 정제된 Top 질문을 확인할 수 있으며, 날짜별 및 상태별 필터링 기능이 정상 작동합니다. 권한 검증도 클라이언트 사이드와 서버 사이드(RLS) 모두에서 구현되어 안전하게 보호됩니다.

**다음 단계**: WP-3.2에서 답변 작성 화면을 구현하면 질문 선택 후 답변을 작성할 수 있게 됩니다.

