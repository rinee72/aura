# Milestone 4: 매니저 기능 및 보안 강화 - Work Package 분해

## 개요

**Milestone 목표**: 매니저의 모니터링/관리 기능 및 AI 악플 필터링 구현

**예상 기간**: 2주 (10일)

**완료 기준**: 매니저가 모든 질문 실시간 모니터링 가능, 문제 질문을 숨기면 셀럽 화면에서 즉시 제거, Edge Function으로 욕설 자동 탐지율 90% 이상, 필터링 로그가 DB에 정상 저장, 주간 리포트 PDF 다운로드 기능 작동

---

## Work Package 구조

```
WP-4.1: 매니저 대시보드 및 질문 모니터링
WP-4.2: 질문 관리 기능 (숨기기/복구)
WP-4.3: AI 악플 필터링 시스템 (Edge Function)
WP-4.4: 셀럽 계정 관리
WP-4.5: 리포트 및 통계
```

---

## WP-4.1: 매니저 대시보드 및 질문 모니터링

### 목표

매니저가 모든 질문을 실시간으로 모니터링하고 민감한 질문을 식별할 수 있는 대시보드 구현

### 사용자 가치

매니저가 플랫폼의 모든 질문을 한눈에 파악하고, 문제가 될 수 있는 질문을 빠르게 발견하여 셀럽을 보호할 수 있음

### 작업 내용

1. **질문 모니터링 서비스**
   - `lib/features/manager/services/question_monitoring_service.dart` 생성
   - `getAllQuestions()`: 모든 질문 조회 (필터링 전, 숨김 포함)
   - `getRecentQuestions()`: 최근 질문 조회 (기본값: 24시간 이내)
   - `getQuestionsByDateRange()`: 날짜별 필터링
   - `getHiddenQuestions()`: 숨김 처리된 질문만 조회
   - `getQuestionsByStatus()`: 상태별 필터링 (pending, answered)
   - 실시간 업데이트 지원 (Supabase Realtime, 선택)

2. **매니저 대시보드 화면**
   - `lib/features/manager/screens/question_monitoring_screen.dart` 생성
   - 질문 목록 표시 (카드 형태)
   - 질문 카드 위젯 (`ManagerQuestionCard`)
     - 질문 내용 표시
     - 작성자 정보 표시
     - 좋아요 수 표시
     - 작성 시간 표시
     - 답변 상태 배지
     - 숨김 상태 표시 (숨김된 질문은 빨간색 배지)
     - 민감 질문 하이라이팅 (위험도 기반, WP-4.3과 연동)

3. **필터링 및 정렬 UI**
   - 상태 필터 (전체, 미답변, 답변완료, 숨김)
   - 날짜 필터 (오늘, 이번 주, 이번 달, 전체)
   - 정렬 옵션 (최신순, 좋아요순, 작성자순)
   - 검색 기능 (질문 내용, 작성자 이름)
   - 새로고침 버튼
   - 실시간 업데이트 토글 (선택)

4. **민감 질문 하이라이팅**
   - 위험도 스코어 표시 (WP-4.3과 연동)
   - 위험도에 따른 색상 구분
     - 높음: 빨간색
     - 중간: 주황색
     - 낮음: 노란색
   - 필터링 로그 표시 (선택)

5. **라우팅 통합**
   - `/manager/monitoring` 라우트 추가
   - 매니저 대시보드에 "질문 모니터링" 버튼 추가
   - 매니저 Bottom Navigation에 통합

### 완료 조건

- [ ] 매니저가 모든 질문을 조회할 수 있음 (숨김 포함)
- [ ] 질문 목록이 정상 표시됨
- [ ] 필터링 및 정렬이 정상 작동함
- [ ] 숨김 처리된 질문이 명확히 표시됨
- [ ] 민감 질문 하이라이팅이 작동함 (WP-4.3 완료 후)
- [ ] 실시간 업데이트가 작동함 (선택)

### 산출물

- 질문 모니터링 화면
- 질문 모니터링 서비스
- ManagerQuestionCard 위젯
- 필터링 및 정렬 기능

### 예상 소요 시간

2일

### 의존성

- WP-2.1 (질문 작성 및 목록)
- WP-1.1 (데이터베이스 스키마 - questions 테이블)
- WP-1.5 (RBAC - 매니저 권한 검증)
- WP-4.3 (AI 악플 필터링 - 민감 질문 하이라이팅용, 선택)

---

## WP-4.2: 질문 관리 기능 (숨기기/복구)

### 목표

매니저가 문제가 되는 질문을 숨기고 복구할 수 있는 기능 구현

### 사용자 가치

매니저가 악성 질문을 즉시 차단하여 셀럽을 보호하고, 실수로 숨긴 질문을 복구할 수 있음

### 작업 내용

1. **질문 관리 서비스**
   - `lib/features/manager/services/question_management_service.dart` 생성
   - `hideQuestion()`: 질문 숨기기
     - `is_hidden = true` 설정
     - `hidden_reason` 기록
     - `hidden_at` 기록
     - `hidden_by` 기록 (현재 매니저 ID)
   - `unhideQuestion()`: 질문 복구
     - `is_hidden = false` 설정
     - `hidden_reason`, `hidden_at`, `hidden_by` 초기화
   - `getHiddenQuestions()`: 숨김 처리된 질문 목록 조회
   - `updateHiddenReason()`: 숨김 사유 수정
   - 권한 검증 (매니저만 가능)

2. **질문 숨기기 화면/다이얼로그**
   - 질문 상세 다이얼로그 또는 화면
   - 숨김 사유 입력 필드 (다중 라인, 필수)
   - 숨김 사유 템플릿 (선택)
     - "욕설/비속어 포함"
     - "개인정보 요구"
     - "스팸/광고"
     - "기타" (직접 입력)
   - 확인 버튼
   - 취소 버튼

3. **숨긴 질문 목록 화면**
   - `lib/features/manager/screens/hidden_questions_screen.dart` 생성
   - 숨김 처리된 질문 목록 표시
   - 숨김 사유 표시
   - 숨김 처리한 매니저 정보 표시
   - 숨김 처리 일시 표시
   - 복구 버튼
   - 검색 및 필터링 기능

4. **질문 카드에 숨기기 버튼 추가**
   - `ManagerQuestionCard`에 숨기기 버튼 추가
   - 숨김 처리된 질문에는 복구 버튼 표시
   - 즉시 반영 (RLS 정책으로 셀럽 화면에서 자동 제거)

5. **라우팅 통합**
   - `/manager/questions/hidden` 라우트 추가
   - 매니저 대시보드에 "숨긴 질문" 버튼 추가

### 완료 조건

- [ ] 매니저가 질문을 숨길 수 있음
- [ ] 숨김 사유를 기록할 수 있음
- [ ] 숨김 처리된 질문이 셀럽 화면에서 즉시 제거됨
- [ ] 매니저가 숨긴 질문 목록을 조회할 수 있음
- [ ] 매니저가 숨긴 질문을 복구할 수 있음
- [ ] 복구된 질문이 셀럽 화면에 다시 표시됨

### 산출물

- 질문 관리 서비스
- 질문 숨기기 다이얼로그/화면
- 숨긴 질문 목록 화면
- 숨기기/복구 기능

### 예상 소요 시간

1.5일

### 의존성

- WP-4.1 (질문 모니터링 - 질문 목록 표시)
- WP-1.1 (데이터베이스 스키마 - questions 테이블의 is_hidden, hidden_reason, hidden_at, hidden_by 컬럼)
- WP-1.5 (RBAC - 매니저 권한 검증)

---

## WP-4.3: AI 악플 필터링 시스템 (Edge Function)

### 목표

Supabase Edge Function을 활용하여 서버 사이드에서 욕설/비속어를 자동으로 탐지하고 필터링하는 시스템 구현

### 사용자 가치

악성 질문이 자동으로 탐지되어 매니저의 수동 개입 없이도 셀럽을 보호할 수 있음. 탐지율 90% 이상 달성

### 작업 내용

1. **필터링 로그 테이블 생성**
   - `supabase/migrations/010_create_filtering_logs_table.sql` 생성
   - `filtering_logs` 테이블
     - `id`: UUID (PK)
     - `question_id`: UUID (FK to questions)
     - `content`: TEXT (원본 질문 내용)
     - `detected_profanities`: JSONB (탐지된 욕설 목록)
     - `risk_score`: INTEGER (위험도 점수, 0-100)
     - `risk_level`: TEXT (위험도 레벨: 'low', 'medium', 'high')
     - `filtered_at`: TIMESTAMPTZ (필터링 일시)
     - `action_taken`: TEXT (조치: 'flagged', 'auto_hidden', 'none')
     - `created_at`: TIMESTAMPTZ

2. **Supabase Edge Function 구현**
   - `supabase/functions/profanity-filter/index.ts` 생성
   - 욕설/비속어 사전 기반 필터
     - 한국어 욕설 사전 (포괄적)
     - 비속어 사전
     - 외래어 욕설 사전
   - 정규식 기반 변형 욕설 탐지
     - 특수문자 변형 (예: 시@발, 시1발)
     - 숫자 변형 (예: 시0발)
     - 공백 삽입 (예: 시 발)
   - 위험도 스코어링 시스템
     - 욕설 개수에 따른 점수
     - 욕설 강도에 따른 가중치
     - 최종 위험도 레벨 계산 (low: 0-30, medium: 31-70, high: 71-100)
   - 필터링 로그 저장
     - `filtering_logs` 테이블에 기록
   - 자동 숨김 처리 (선택)
     - 위험도가 'high'인 경우 자동으로 `is_hidden = true` 설정

3. **Edge Function 배포 및 설정**
   - Supabase Dashboard에서 Edge Function 배포
   - 환경 변수 설정 (욕설 사전 등, 선택)
   - 트리거 설정 (질문 생성 시 자동 실행, 선택)

4. **클라이언트 통합**
   - `lib/features/manager/services/profanity_filter_service.dart` 생성
   - `checkProfanity()`: Edge Function 호출
   - `getFilteringLogs()`: 필터링 로그 조회
   - `getFilteringStats()`: 필터링 통계 조회

5. **매니저 화면 통합**
   - 질문 모니터링 화면에 위험도 표시
   - 필터링 로그 화면 추가 (선택)
   - 위험도 기반 자동 정렬

### 완료 조건

- [ ] Edge Function이 정상 작동함
- [ ] 욕설 자동 탐지율 90% 이상 달성
- [ ] 필터링 로그가 DB에 정상 저장됨
- [ ] 위험도 스코어링이 정확함
- [ ] 매니저 화면에 위험도가 표시됨
- [ ] 자동 숨김 처리가 작동함 (선택)

### 산출물

- Supabase Edge Function (profanity-filter)
- 필터링 로그 테이블 및 마이그레이션
- ProfanityFilterService
- 필터링 로그 화면 (선택)

### 예상 소요 시간

3일

### 의존성

- WP-4.1 (질문 모니터링 - 위험도 표시용)
- WP-1.1 (데이터베이스 스키마 - questions 테이블)
- Supabase Edge Functions 설정

**참고**: Edge Function은 Deno 런타임을 사용하며, TypeScript로 작성됩니다.

---

## WP-4.4: 셀럽 계정 관리

### 목표

매니저가 셀럽 계정을 관리하고 프로필을 수정할 수 있는 기능 구현

### 사용자 가치

매니저가 셀럽의 프로필을 관리하여 브랜드 일관성을 유지하고, 필요시 셀럽을 대신하여 콘텐츠를 관리할 수 있음

### 작업 내용

1. **셀럽 계정 관리 서비스**
   - `lib/features/manager/services/celebrity_management_service.dart` 생성
   - `getAllCelebrities()`: 모든 셀럽 목록 조회
   - `getCelebrityProfile()`: 특정 셀럽 프로필 조회
   - `updateCelebrityProfile()`: 셀럽 프로필 수정
     - `display_name` 수정
     - `bio` 수정
     - `avatar_url` 수정 (선택)
   - `getCelebrityStats()`: 셀럽 통계 조회
     - 구독자 수
     - 답변 수
     - 피드 수
     - 최근 활동 일시
   - 권한 검증 (매니저만 가능)

2. **셀럽 목록 화면**
   - `lib/features/manager/screens/celebrities_list_screen.dart` 생성
   - 셀럽 목록 표시 (카드 형태)
   - 셀럽 카드 위젯 (`ManagerCelebrityCard`)
     - 프로필 이미지
     - 이름/닉네임
     - 구독자 수
     - 답변 수
     - 최근 활동 일시
   - 검색 기능 (이름, 이메일)
   - 정렬 옵션 (이름순, 구독자순, 최근 활동순)

3. **셀럽 프로필 관리 화면**
   - `lib/features/manager/screens/celebrity_profile_management_screen.dart` 생성
   - 프로필 정보 표시 (읽기 전용)
   - 프로필 수정 폼
     - 이름/닉네임 수정
     - 소개글 수정
     - 프로필 이미지 수정 (선택)
   - 통계 섹션
     - 구독자 수
     - 답변 수
     - 피드 수
   - 저장 버튼
   - 취소 버튼

4. **답변 대리 작성 기능 (선택)**
   - `createAnswerOnBehalf()`: 매니저가 셀럽을 대신하여 답변 작성
   - 권한 검증 (매니저만 가능)
   - 답변 작성 화면에 "대리 작성" 표시

5. **라우팅 통합**
   - `/manager/celebrities` 라우트 추가
   - `/manager/celebrities/:celebrityId` 라우트 추가
   - `/manager/celebrities/:celebrityId/edit` 라우트 추가
   - 매니저 대시보드에 "셀럽 관리" 버튼 추가

### 완료 조건

- [ ] 매니저가 모든 셀럽 목록을 조회할 수 있음
- [ ] 매니저가 셀럽 프로필을 수정할 수 있음
- [ ] 셀럽 통계가 정상 표시됨
- [ ] 매니저가 셀럽을 대신하여 답변을 작성할 수 있음 (선택)
- [ ] 프로필 수정이 셀럽 화면에 반영됨

### 산출물

- 셀럽 계정 관리 서비스
- 셀럽 목록 화면
- 셀럽 프로필 관리 화면
- ManagerCelebrityCard 위젯

### 예상 소요 시간

2일

### 의존성

- WP-1.1 (데이터베이스 스키마 - users 테이블)
- WP-1.5 (RBAC - 매니저 권한 검증)
- WP-3.2 (답변 작성 시스템 - 대리 작성용, 선택)

---

## WP-4.5: 리포트 및 통계

### 목표

필터링된 질문 통계, 일일/주간/월간 리포트, 이슈성 키워드 트렌드를 제공하는 시스템 구현

### 사용자 가치

매니저가 플랫폼의 전반적인 상황을 파악하고, 트렌드를 분석하여 예방 조치를 취할 수 있음

### 작업 내용

1. **통계 서비스**
   - `lib/features/manager/services/report_service.dart` 생성
   - `getFilteringStats()`: 필터링 통계 조회
     - 전체 질문 수
     - 필터링된 질문 수
     - 위험도별 분포 (low, medium, high)
     - 탐지율 계산
   - `getDailyReport()`: 일일 리포트 데이터 조회
   - `getWeeklyReport()`: 주간 리포트 데이터 조회
   - `getMonthlyReport()`: 월간 리포트 데이터 조회
   - `getTrendingKeywords()`: 이슈성 키워드 트렌드 조회
     - 필터링된 질문에서 자주 나타나는 키워드
     - 시간대별 트렌드 분석

2. **리포트 모델**
   - `lib/features/manager/models/report_model.dart` 생성
   - 리포트 데이터 구조 정의
   - 통계 데이터 구조 정의

3. **리포트 화면**
   - `lib/features/manager/screens/reports_screen.dart` 생성
   - 탭 구조 (일일, 주간, 월간)
   - 통계 카드 위젯
     - 전체 질문 수
     - 필터링된 질문 수
     - 탐지율
     - 위험도별 분포 (파이 차트 또는 막대 그래프)
   - 이슈성 키워드 트렌드 섹션
     - 키워드 목록
     - 빈도수 표시
     - 트렌드 그래프 (선택)

4. **PDF 다운로드 기능**
   - `generateReportPDF()`: 리포트 PDF 생성
   - `downloadReport()`: PDF 다운로드
   - PDF 라이브러리 사용 (예: `pdf` 패키지)
   - 리포트 템플릿
     - 헤더 (로고, 제목, 날짜)
     - 통계 섹션
     - 이슈성 키워드 섹션
     - 차트/그래프 (선택)

5. **라우팅 통합**
   - `/manager/reports` 라우트 추가
   - 매니저 대시보드에 "리포트" 버튼 추가

### 완료 조건

- [ ] 필터링 통계가 정상 표시됨
- [ ] 일일/주간/월간 리포트가 정상 작동함
- [ ] 이슈성 키워드 트렌드가 표시됨
- [ ] PDF 다운로드 기능이 작동함
- [ ] 리포트 데이터가 정확함

### 산출물

- 리포트 서비스
- 리포트 화면
- 리포트 모델
- PDF 생성 기능

### 예상 소요 시간

2일

### 의존성

- WP-4.3 (AI 악플 필터링 - 필터링 로그 데이터)
- WP-4.1 (질문 모니터링 - 질문 데이터)
- PDF 생성 라이브러리

---

## Work Package 의존성 다이어그램

```
WP-4.1 (매니저 대시보드 및 질문 모니터링)
    ↓
WP-4.2 (질문 관리 기능) ← WP-4.1
    ↓
WP-4.3 (AI 악플 필터링) ← 독립적 (병렬 개발 가능)
    ↓
WP-4.4 (셀럽 계정 관리) ← 독립적 (병렬 개발 가능)
    ↓
WP-4.5 (리포트 및 통계) ← WP-4.1, WP-4.3
```

---

## 전체 타임라인 (10일 기준)

| 일차 | Work Package | 누적 진행률 |
|------|--------------|------------|
| 1-2일 | WP-4.1: 매니저 대시보드 및 질문 모니터링 | 20% |
| 3-4일 | WP-4.2: 질문 관리 기능 | 40% |
| 5-7일 | WP-4.3: AI 악플 필터링 시스템 | 70% |
| 8-9일 | WP-4.4: 셀럽 계정 관리 | 90% |
| 10일 | WP-4.5: 리포트 및 통계 | 100% |

---

## Vertical Slicing 원칙 적용

각 Work Package는 **독립적으로 테스트 가능한 사용자 가치**를 전달합니다:

1. **WP-4.1**: 질문 모니터링 → 문제 질문 발견 (핵심 가치 전달)
2. **WP-4.2**: 질문 숨기기/복구 → 즉시 조치 가능 (핵심 가치 전달)
3. **WP-4.3**: AI 악플 필터링 → 자동 보호 시스템 (핵심 가치 전달)
4. **WP-4.4**: 셀럽 계정 관리 → 브랜드 관리 (추가 가치)
5. **WP-4.5**: 리포트 및 통계 → 데이터 기반 의사결정 (추가 가치)

각 WP 완료 후에는 **"동작하는 소프트웨어"**가 생성되며, 사용자가 실제로 테스트할 수 있는 상태입니다.

---

## 완료 조건 체크리스트 (Milestone 4 전체)

- [ ] 매니저가 모든 질문 실시간 모니터링 가능
- [ ] 문제 질문을 숨기면 셀럽 화면에서 즉시 제거
- [ ] Edge Function으로 욕설 자동 탐지율 90% 이상
- [ ] 필터링 로그가 DB에 정상 저장
- [ ] 주간 리포트 PDF 다운로드 기능 작동
- [ ] 매니저가 셀럽 프로필을 수정할 수 있음
- [ ] 매니저가 숨긴 질문을 복구할 수 있음

---

## 기술적 고려사항

### 1. 실시간 업데이트
- Supabase Realtime을 활용하여 새 질문이 실시간으로 표시
- 질문 숨김 처리 시 셀럽 화면에 즉시 반영

### 2. Edge Function 성능
- Deno 런타임 활용
- 욕설 사전을 효율적으로 검색 (해시맵 또는 트라이 구조)
- 정규식 최적화

### 3. 권한 관리
- 매니저만 접근 가능한 기능 (PermissionChecker 활용)
- RLS 정책으로 데이터베이스 레벨 권한 검증
- Edge Function에서도 권한 검증

### 4. 데이터 보안
- 필터링 로그는 매니저만 조회 가능
- 셀럽 프로필 수정 이력 기록 (선택)

### 5. 성능 최적화
- 통계 쿼리 최적화 (인덱스 활용)
- 리포트 생성 시 캐싱 고려
- PDF 생성 비동기 처리

---

## 향후 확장 가능성

1. **고급 필터링**
   - 머신러닝 기반 감정 분석
   - 문맥 기반 욕설 탐지
   - 다국어 욕설 탐지

2. **자동화 규칙**
   - 위험도 기반 자동 숨김 규칙 설정
   - 특정 키워드 자동 차단
   - 사용자별 차단 규칙

3. **알림 시스템**
   - 위험도 높은 질문 알림
   - 일일 필터링 요약 알림
   - 트렌드 변화 알림

4. **고급 리포트**
   - 대시보드 시각화
   - 예측 분석
   - 비교 리포트 (전월 대비 등)

---

## 리스크 관리

### High Risk
- **Edge Function 탐지율**: 90% 탐지율 미달성 가능
  - **완화 전략**: 사전 기반 + 정규식 하이브리드 접근, 지속적 사전 업데이트, 베타 테스트를 통한 정확도 개선

- **실시간 성능**: 많은 질문이 동시에 생성될 때 성능 저하
  - **완화 전략**: 페이지네이션, 캐싱, 배치 처리

### Medium Risk
- **PDF 생성 성능**: 리포트 데이터가 많을 때 생성 시간 증가
  - **완화 전략**: 비동기 처리, 백그라운드 작업, 캐싱

- **Edge Function 배포**: Supabase Edge Function 배포 실패
  - **완화 전략**: 로컬 테스트, 단계적 배포, 롤백 계획

---

## 참고 사항

1. **Edge Function 개발 환경**
   - Supabase CLI 사용 권장
   - 로컬 테스트 환경 구축

2. **욕설 사전 관리**
   - 외부 파일 또는 데이터베이스에서 로드하는 것을 권장
   - 정기적인 사전 업데이트 프로세스 필요

3. **필터링 로그 보관**
   - 장기 보관 정책 수립
   - 개인정보 보호 고려 (GDPR 등)

4. **성능 모니터링**
   - Edge Function 실행 시간 모니터링
   - 데이터베이스 쿼리 성능 모니터링


