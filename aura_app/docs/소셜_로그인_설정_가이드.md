# 소셜 로그인 설정 가이드

**WP-1.6: 소셜 로그인 연동**

이 문서는 Google 및 Apple 소셜 로그인을 Supabase와 Flutter 앱에 설정하는 방법을 설명합니다.

---

## 개요

Supabase는 OAuth를 통해 Google 및 Apple 소셜 로그인을 지원합니다. Flutter 앱에서는 별도의 패키지(google_sign_in, sign_in_with_apple) 없이 Supabase의 내장 OAuth 기능을 사용하여 소셜 로그인을 구현합니다.

### 지원 플랫폼

- **Google 로그인**: 모든 플랫폼 (Web, iOS, Android, Windows, macOS, Linux)
- **Apple 로그인**: iOS 및 macOS만 지원

---

## 1. Google 로그인 설정

### 1.1 Google Cloud Console 설정

1. **Google Cloud Console 접속**
   - [Google Cloud Console](https://console.cloud.google.com/)에 접속
   - 프로젝트 선택 또는 새 프로젝트 생성

2. **OAuth 동의 화면 구성**
   - 좌측 메뉴 > **API 및 서비스** > **OAuth 동의 화면**
   - 사용자 유형 선택 (외부 또는 내부)
   - 앱 정보 입력:
     - 앱 이름: AURA
     - 사용자 지원 이메일: [이메일 주소]
     - 개발자 연락처 정보: [이메일 주소]
   - 범위: 기본 범위만 선택 (email, profile, openid)
   - 저장 및 계속

3. **OAuth 클라이언트 ID 생성**
   - 좌측 메뉴 > **API 및 서비스** > **사용자 인증 정보**
   - **+ 사용자 인증 정보 만들기** > **OAuth 클라이언트 ID**
   - 애플리케이션 유형별로 클라이언트 ID 생성:

   **웹 애플리케이션 (Web)**:
   - 이름: AURA Web Client
   - 승인된 자바스크립트 원본:
     - `https://[your-project-ref].supabase.co`
     - `http://localhost:3000` (개발용)
   - 승인된 리디렉션 URI:
     - `https://[your-project-ref].supabase.co/auth/v1/callback`
     - `http://localhost:3000/auth/callback` (개발용)

   **iOS**:
   - 이름: AURA iOS Client
   - 번들 ID: `com.aura.app` (실제 번들 ID 사용)
   - App Store ID: (선택사항)

   **Android**:
   - 이름: AURA Android Client
   - 패키지 이름: `com.aura.app` (실제 패키지 이름 사용)
   - SHA-1 인증서 지문: (앱 서명 인증서의 SHA-1 지문)
     ```bash
     # Debug 키스토어의 SHA-1 확인
     keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android -keypass android
     ```

4. **클라이언트 ID 및 시크릿 복사**
   - 생성된 클라이언트 ID와 클라이언트 시크릿을 안전하게 보관

### 1.2 Supabase 설정

1. **Supabase Dashboard 접속**
   - [Supabase Dashboard](https://app.supabase.com/)에 접속
   - 프로젝트 선택

2. **Authentication > Providers 설정**
   - 좌측 메뉴 > **Authentication** > **Providers**
   - **Google** 프로바이더 찾기

3. **Google Provider 활성화**
   - **Enable Google provider** 토글 ON
   - **Client ID (for OAuth)**: Google Cloud Console에서 복사한 클라이언트 ID 입력
   - **Client Secret (for OAuth)**: Google Cloud Console에서 복사한 클라이언트 시크릿 입력
   - **Save** 클릭

4. **리디렉트 URL 설정**
   - **Authentication** > **URL Configuration**
   - **Redirect URLs**에 다음 추가:
     ```
     https://[your-project-ref].supabase.co/auth/v1/callback
     com.aura.app://login-callback
     ```
   - (실제 URL 스킴은 프로젝트에 맞게 수정)

### 1.3 Flutter 앱 설정

#### Android 설정

1. **AndroidManifest.xml 수정**
   ```xml
   <activity
       android:name=".MainActivity"
       android:launchMode="singleTop"
       android:theme="@style/LaunchTheme"
       android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
       android:hardwareAccelerated="true"
       android:windowSoftInputMode="adjustResize">
       <!-- OAuth 딥링크를 위한 인텐트 필터 -->
       <intent-filter>
           <action android:name="android.intent.action.VIEW" />
           <category android:name="android.intent.category.DEFAULT" />
           <category android:name="android.intent.category.BROWSABLE" />
           <data android:scheme="com.aura.app" />
       </intent-filter>
   </activity>
   ```

#### iOS 설정

1. **Info.plist 수정**
   ```xml
   <key>CFBundleURLTypes</key>
   <array>
       <dict>
           <key>CFBundleTypeRole</key>
           <string>Editor</string>
           <key>CFBundleURLSchemes</key>
           <array>
               <string>com.aura.app</string>
           </array>
       </dict>
   </array>
   ```

#### Web 설정

- 별도 설정 불필요 (Supabase가 자동으로 처리)

---

## 2. Apple 로그인 설정 (iOS/macOS)

### 2.1 Apple Developer 설정

1. **Apple Developer 계정 접속**
   - [Apple Developer](https://developer.apple.com/)에 접속
   - 계정 로그인

2. **App ID 설정**
   - **Certificates, Identifiers & Profiles** > **Identifiers**
   - 앱의 App ID 선택 (또는 생성)
   - **Sign in with Apple** 기능 활성화
   - **Save** 클릭

3. **Services ID 생성**
   - **Identifiers** > **+** 버튼 클릭
   - **Services IDs** 선택 > **Continue**
   - 설명 입력 (예: AURA Web Service)
   - Identifier 입력 (예: `com.aura.app.service`)
   - **Sign in with Apple** 체크 > **Configure**
   - Primary App ID 선택
   - Website URLs 설정:
     - Domains and Subdomains: `supabase.co`
     - Return URLs: `https://[your-project-ref].supabase.co/auth/v1/callback`
   - **Save** > **Continue** > **Register**

4. **Key 생성**
   - **Keys** > **+** 버튼 클릭
   - Key Name 입력 (예: AURA Sign in with Apple Key)
   - **Sign in with Apple** 체크 > **Configure**
   - Primary App ID 선택 > **Save**
   - **Continue** > **Register**
   - **Download** 버튼으로 .p8 키 파일 다운로드 (한 번만 다운로드 가능!)
   - Key ID 기록

### 2.2 Supabase 설정

1. **Supabase Dashboard > Authentication > Providers**
   - **Apple** 프로바이더 찾기

2. **Apple Provider 활성화**
   - **Enable Apple provider** 토글 ON
   - **Services ID**: Apple Developer에서 생성한 Services ID 입력
   - **Secret Key**: .p8 키 파일 내용 입력 (-----BEGIN PRIVATE KEY----- ... -----END PRIVATE KEY-----)
   - **Key ID**: Apple Developer에서 생성한 Key ID 입력
   - **Team ID**: Apple Developer 계정의 Team ID 입력 (https://developer.apple.com/account에서 확인 가능)
   - **Save** 클릭

---

## 3. 코드 구현

### 3.1 AuthProvider에 소셜 로그인 메서드 추가

`lib/features/auth/providers/auth_provider.dart`에 다음 메서드가 추가되었습니다:

```dart
/// Google 소셜 로그인
Future<void> signInWithGoogle() async {
  // Supabase OAuth를 통한 Google 로그인
  await client.auth.signInWithOAuth(
    OAuthProvider.google,
    redirectTo: _getRedirectUrl(),
    authScreenLaunchMode: LaunchMode.externalApplication,
  );
}

/// Apple 소셜 로그인 (iOS/macOS 전용)
Future<void> signInWithApple() async {
  await client.auth.signInWithOAuth(
    OAuthProvider.apple,
    redirectTo: _getRedirectUrl(),
    authScreenLaunchMode: LaunchMode.externalApplication,
  );
}
```

### 3.2 로그인 화면에 소셜 로그인 버튼 추가

`lib/features/auth/screens/login_screen.dart`에 소셜 로그인 버튼이 추가되었습니다:

- Google 로그인 버튼 (모든 플랫폼)
- Apple 로그인 버튼 (iOS/macOS만 표시)

### 3.3 소셜 로그인 플로우

1. 사용자가 소셜 로그인 버튼 클릭
2. `AuthProvider.signInWithGoogle()` 또는 `signInWithApple()` 호출
3. Supabase OAuth URL로 리다이렉트 (웹) 또는 외부 브라우저/앱 열림 (모바일)
4. 사용자가 소셜 계정으로 로그인
5. OAuth 콜백 URL로 리다이렉트
6. Supabase가 인증 완료 및 세션 생성
7. `onAuthStateChange` 리스너가 `signedIn` 이벤트 감지
8. `_loadUserProfile()` 호출하여 사용자 프로필 로드
9. 프로필이 없거나 역할이 없으면 `/role-selection`으로 리다이렉트
10. 역할이 있으면 역할별 홈 화면으로 리다이렉트

---

## 4. 역할 선택 통합

소셜 로그인 후에도 일반 회원가입과 동일하게 역할 선택 화면이 표시됩니다:

1. **새 사용자**: 소셜 로그인 후 프로필이 없거나 역할이 없으면 `/role-selection`으로 이동
2. **기존 사용자**: 이미 프로필과 역할이 있으면 역할별 홈 화면으로 이동

이 로직은 `lib/core/router/app_router.dart`의 `_handleRedirect()` 메서드에서 처리됩니다:

```dart
// 역할이 설정되지 않은 경우 역할 선택 화면으로 리다이렉트
if (role == null || role.isEmpty) {
  if (currentPath == '/role-selection') {
    return null;
  }
  return '/role-selection';
}
```

---

## 5. 테스트

### 5.1 Google 로그인 테스트

1. 앱 실행
2. 로그인 화면에서 "Google로 계속하기" 버튼 클릭
3. Google 로그인 화면 표시 확인
4. Google 계정으로 로그인
5. 역할 선택 화면 또는 홈 화면으로 이동 확인

### 5.2 Apple 로그인 테스트 (iOS/macOS)

1. iOS/macOS 디바이스 또는 시뮬레이터에서 앱 실행
2. 로그인 화면에서 "Apple로 계속하기" 버튼 표시 확인 (웹/Android에서는 표시되지 않음)
3. 버튼 클릭
4. Sign in with Apple 화면 표시 확인
5. Apple ID로 로그인
6. 역할 선택 화면 또는 홈 화면으로 이동 확인

---

## 6. 문제 해결

### 6.1 "redirect_uri_mismatch" 오류

**원인**: Google Cloud Console에 등록된 리디렉트 URI와 Supabase에서 사용하는 URI가 일치하지 않음

**해결**:
1. Google Cloud Console > OAuth 클라이언트 설정 확인
2. 승인된 리디렉션 URI에 `https://[your-project-ref].supabase.co/auth/v1/callback` 추가
3. Supabase Dashboard > Authentication > URL Configuration 확인

### 6.2 Apple 로그인이 작동하지 않음

**확인 사항**:
1. App ID에 "Sign in with Apple" 기능이 활성화되어 있는지
2. Services ID가 올바르게 설정되어 있는지
3. .p8 키 파일과 Key ID, Team ID가 올바르게 입력되었는지
4. Supabase Dashboard에서 Apple Provider가 활성화되어 있는지

### 6.3 모바일에서 딥링크가 작동하지 않음

**확인 사항**:
1. Android: AndroidManifest.xml에 인텐트 필터가 올바르게 설정되어 있는지
2. iOS: Info.plist에 URL Schemes가 올바르게 설정되어 있는지
3. Supabase Dashboard의 리디렉트 URL에 URL 스킴이 포함되어 있는지 (예: `com.aura.app://login-callback`)

---

## 7. 보안 고려사항

1. **클라이언트 시크릿 보관**
   - Google 클라이언트 시크릿은 Supabase Dashboard에만 저장
   - 코드에 하드코딩하지 않음

2. **Apple Secret Key 보관**
   - .p8 키 파일은 Supabase Dashboard에만 저장
   - Git 저장소에 커밋하지 않음

3. **리디렉트 URL 검증**
   - Supabase가 자동으로 리디렉트 URL을 검증하므로 안전함

---

## 8. 참고 자료

- [Supabase Auth 문서](https://supabase.com/docs/guides/auth)
- [Supabase OAuth 가이드](https://supabase.com/docs/guides/auth/social-login/auth-google)
- [Google OAuth 설정](https://developers.google.com/identity/protocols/oauth2)
- [Apple Sign in with Apple 가이드](https://developer.apple.com/sign-in-with-apple/)

---

**작성일**: 2024년  
**작성자**: AURA 개발팀  
**버전**: 1.0

